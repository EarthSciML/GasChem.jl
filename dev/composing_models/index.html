<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Composing models · GasChem.jl</title><meta name="title" content="Composing models · GasChem.jl"/><meta property="og:title" content="Composing models · GasChem.jl"/><meta property="twitter:title" content="Composing models · GasChem.jl"/><meta name="description" content="Documentation for GasChem.jl."/><meta property="og:description" content="Documentation for GasChem.jl."/><meta property="twitter:description" content="Documentation for GasChem.jl."/><meta property="og:url" content="https://gaschem.earthsci.dev/composing_models/"/><meta property="twitter:url" content="https://gaschem.earthsci.dev/composing_models/"/><link rel="canonical" href="https://gaschem.earthsci.dev/composing_models/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">GasChem.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../AtmosphericLifetime/">Atmospheric Lifetime</a></li><li><a class="tocitem" href="../superfast/">SuperFast</a></li><li><span class="tocitem">GEOS-Chem</span><ul><li><a class="tocitem" href="../geoschem/overview/">Overview</a></li><li><a class="tocitem" href="../geoschem/states/">State Variables</a></li><li><a class="tocitem" href="../geoschem/params/">Parameters</a></li></ul></li><li><span class="tocitem">Seinfeld &amp; Pandis Ch. 6</span><ul><li><a class="tocitem" href="../oh_production/">OH Production</a></li><li><a class="tocitem" href="../nox_photochemistry/">NOx Photochemistry</a></li><li><a class="tocitem" href="../co_oxidation/">CO Oxidation</a></li><li><a class="tocitem" href="../methane_oxidation/">Methane Oxidation</a></li><li><a class="tocitem" href="../combined_system/">Combined System</a></li></ul></li><li><a class="tocitem" href="../radiation_fundamentals/">Radiation Fundamentals</a></li><li><a class="tocitem" href="../StratosphericChemistry/">Stratospheric Chemistry</a></li><li><a class="tocitem" href="../climate_forcing/">Climate Forcing</a></li><li class="is-active"><a class="tocitem" href>Composing models</a><ul class="internal"><li><a class="tocitem" href="#Illustrative-Example"><span>Illustrative Example</span></a></li><li><a class="tocitem" href="#Adding-Emission-Data"><span>Adding Emission Data</span></a></li></ul></li><li><a class="tocitem" href="../api/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Composing models</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Composing models</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/EarthSciML/GasChem.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/EarthSciML/GasChem.jl/blob/main/docs/src/composing_models.md#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Composing-Models"><a class="docs-heading-anchor" href="#Composing-Models">Composing Models</a><a id="Composing-Models-1"></a><a class="docs-heading-anchor-permalink" href="#Composing-Models" title="Permalink"></a></h1><h2 id="Illustrative-Example"><a class="docs-heading-anchor" href="#Illustrative-Example">Illustrative Example</a><a id="Illustrative-Example-1"></a><a class="docs-heading-anchor-permalink" href="#Illustrative-Example" title="Permalink"></a></h2><p>Here is the complete example of composing, visualizing and solving the SuperFast model and the Fast-JX model, with explanation to follow:</p><pre><code class="language-julia hljs">using EarthSciMLBase, GasChem, ModelingToolkit, Dates, DynamicQuantities,
      OrdinaryDiffEqDefault, OrdinaryDiffEqRosenbrock
using ModelingToolkit: t

start = Dates.datetime2unix(Dates.DateTime(2024, 2, 29))

composed_ode = couple(SuperFast(), FastJX(start)) # Compose two models use the &quot;couple&quot; function

tspan = (0.0, 3600.0*24*3)
sys = convert(System, composed_ode) # Define the coupled system
sol = solve(ODEProblem(sys, [], tspan; build_initializeprob = false), Rosenbrock23(), saveat = 10.0) # Solve the coupled system</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">retcode: Success
Interpolation: 1st order linear
t: 25921-element Vector{Float64}:
      0.0
     10.0
     20.0
     30.0
     40.0
     50.0
     60.0
     70.0
     80.0
     90.0
      ⋮
 259120.0
 259130.0
 259140.0
 259150.0
 259160.0
 259170.0
 259180.0
 259190.0
 259200.0
u: 25921-element Vector{Vector{Float64}}:
 [4.0e-6, 4.0e-6, 1.0e-11, 4.0e-6, 100.0, 4.0e-6, 4.0e-6, 0.0004, 0.0004, 4.0e-6, 4.0e-6, 40.0]
 [4.004693536823848e-6, 7.555737757901071e-6, 9.998972376097728e-12, 3.999997927531718e-6, 99.99999714077377, 4.003792439697488e-6, 4.860325366148434e-6, 0.0004550988275869166, 0.0003448923522681513, 2.5624100789855345e-8, 1.9795573986580456e-9, 39.999944613914295]
 [4.00931170071799e-6, 7.565258654003263e-6, 9.998072481269013e-12, 3.999998025993034e-6, 99.9999971385579, 4.007136616709668e-6, 4.8576507379516386e-6, 0.0005026437736859495, 0.00029733817050274616, 1.2066408588345583e-8, -8.335884319884574e-10, 39.99989706258979]
 [4.014353499932067e-6, 7.567938949305817e-6, 9.997172786872484e-12, 3.999998091203613e-6, 99.99999713899528, 4.010020375064599e-6, 4.854634699133824e-6, 0.0005436548631054937, 0.00025631699717987104, 8.912900515847617e-9, -2.726729187048979e-11, 39.99985604415711]
 [4.019760098798411e-6, 7.5697282394540175e-6, 9.996273155389757e-12, 3.9999981417935426e-6, 99.9999971390087, 4.012509328617121e-6, 4.852141609521375e-6, 0.0005790567765000634, 0.0002209042705992016, 7.648847071275135e-9, 1.4837308454446617e-10, 39.99982063376831]
 [4.025491357215177e-6, 7.571115822784641e-6, 9.995373595791962e-12, 3.999998184849722e-6, 99.99999713880197, 4.014646873856254e-6, 4.850066467858313e-6, 0.0006094628029410319, 0.0001904867817177537, 7.097300092591027e-9, -3.0756693736231878e-12, 39.999790218261026]
 [4.031478906503311e-6, 7.5723046859500265e-6, 9.994474122281839e-12, 3.999998225008896e-6, 99.99999713869708, 4.016507324360622e-6, 4.848237652804021e-6, 0.0006359240518261505, 0.00016401355776153877, 6.5649349743674566e-9, -2.2538504074098952e-11, 39.99976374676078]
 [4.037716787515752e-6, 7.573313628594943e-6, 9.993574732307505e-12, 3.999998261903524e-6, 99.99999713863714, 4.018097193632985e-6, 4.846665840885406e-6, 0.0006585322396355515, 0.00014139289420049458, 6.082711354098904e-9, 1.0718987894825252e-11, 39.99974112756372]
 [4.044151327432548e-6, 7.574192028470365e-6, 9.992675423145485e-12, 3.9999982956056e-6, 99.99999713856415, 4.019474665617479e-6, 4.845310368458912e-6, 0.0006781130633596583, 0.00012179920142023248, 5.6716801767268285e-9, 1.7524728173732075e-11, 39.99972153513115]
 [4.050759355263616e-6, 7.574961173304418e-6, 9.991776195205248e-12, 3.999998327668635e-6, 99.9999971384887, 4.0206648803360484e-6, 4.844142908809367e-6, 0.0006950241082180128, 0.00010487494053256063, 5.301991925146901e-9, 1.3483583874263725e-11, 39.99970461194968]
 ⋮
 [0.0001576380916701674, 4.0457266148516124e-5, 9.69314730227955e-13, 3.6655554851307216e-6, 99.9999515921197, 5.792081897655176e-6, 1.2083973450397241e-5, 0.0004925743917439106, 1.64101941534491e-7, 5.791053664397864e-10, 1.897377672673501e-12, 39.99956882307697]
 [0.00015764283941926475, 4.045727470116981e-5, 9.692275034456431e-13, 3.6655554614967516e-6, 99.999951592112, 5.792113372324482e-6, 1.2083944169585246e-5, 0.0004925488324893425, 1.8016569981079253e-7, 5.738779856633304e-10, 1.9359448666174695e-12, 39.99956883913163]
 [0.00015764758697986295, 4.04572831481708e-5, 9.691402845124242e-13, 3.6655554414093813e-6, 99.99995159210435, 5.792145132538873e-6, 1.2083914605003797e-5, 0.0004925277265427961, 1.9177652704455776e-7, 5.691462987193939e-10, 1.9368190306778154e-12, 39.99956885073372]
 [0.000157652334351962, 4.045729148951909e-5, 9.690530734282982e-13, 3.6655554248686117e-6, 99.99995159209675, 5.792177178298351e-6, 1.2083884756652896e-5, 0.0004925110739042714, 1.989344232357865e-7, 5.649103056079772e-10, 1.9000001648545378e-12, 39.999568857883254]
 [0.0001576570815355619, 4.0457299725214675e-5, 9.689658701932653e-13, 3.6655554118744428e-6, 99.9999515920892, 5.792209509602913e-6, 1.208385462453254e-5, 0.0004924988745737685, 2.0163938838447884e-7, 5.611700063290802e-10, 1.8254882691476373e-12, 39.99956886058021]
 [0.00015766182853066264, 4.0457307855257565e-5, 9.688786748073253e-13, 3.6655554024268736e-6, 99.9999515920817, 5.792242126452562e-6, 1.2083824208642731e-5, 0.0004924911285512872, 1.9989142249063467e-7, 5.579254008827029e-10, 1.713283343557113e-12, 39.999568858824595]
 [0.0001576665753372642, 4.0457315879647745e-5, 9.687914872704786e-13, 3.6655553965259046e-6, 99.99995159207425, 5.792275028847296e-6, 1.2083793508983469e-5, 0.0004924878358368277, 1.9369052555425416e-7, 5.551764892688451e-10, 1.5633853880829655e-12, 39.99956885261641]
 [0.00015767132195536662, 4.0457323798385236e-5, 9.687043075827249e-13, 3.6655553941715363e-6, 99.99995159206685, 5.792308216787115e-6, 1.2083762525554752e-5, 0.00049248899643039, 1.830366975753372e-7, 5.529232714875072e-10, 1.3757944027251948e-12, 39.999568841955664]
 [0.00015767606838496987, 4.0457331611470016e-5, 9.68617135744064e-13, 3.6655553953637682e-6, 99.9999515920595, 5.792341690272021e-6, 1.2083731258356583e-5, 0.000492494610331974, 1.6792993855388383e-7, 5.511657475386889e-10, 1.1505103874838008e-12, 39.99956882684235]</code></pre><p>In the composed system, the variable name for O₃ is not <code>O3</code> but <code>superfast₊O3(t)</code>. So we need some preparation of the result before visualizing.</p><pre><code class="language-julia hljs">vars = unknowns(sys)  # Get the variables in the composed system
var_dict = Dict(string(var) =&gt; var for var in vars)
pols = [&quot;O3&quot;, &quot;OH&quot;, &quot;NO&quot;, &quot;NO2&quot;, &quot;CH3O2&quot;, &quot;CO&quot;, &quot;CH3OOH&quot;, &quot;CH2O&quot;, &quot;ISOP&quot;]
var_names_p = [&quot;SuperFast₊$(v)(t)&quot; for v in pols]

x_t = unix2datetime.(sol[t] .+ start) # Convert from unixtime to date time for visualizing</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">25921-element Vector{Dates.DateTime}:
 2024-02-29T00:00:00
 2024-02-29T00:00:10
 2024-02-29T00:00:20
 2024-02-29T00:00:30
 2024-02-29T00:00:40
 2024-02-29T00:00:50
 2024-02-29T00:01:00
 2024-02-29T00:01:10
 2024-02-29T00:01:20
 2024-02-29T00:01:30
 ⋮
 2024-03-02T23:58:40
 2024-03-02T23:58:50
 2024-03-02T23:59:00
 2024-03-02T23:59:10
 2024-03-02T23:59:20
 2024-03-02T23:59:30
 2024-03-02T23:59:40
 2024-03-02T23:59:50
 2024-03-03T00:00:00</code></pre><p>Then, we could plot the results as:</p><pre><code class="language-julia hljs">using Plots
pp = []
for (i, v) in enumerate(var_names_p)
    name = pols[i]
    push!(pp,
        Plots.plot(
            x_t, sol[var_dict[v]], label = &quot;$name&quot;, size = (1000, 600), xrotation = 45))
end
Plots.plot(pp..., layout = (3, 3))</code></pre><img src="4f8bdf14.svg" alt="Example block output"/><h2 id="Adding-Emission-Data"><a class="docs-heading-anchor" href="#Adding-Emission-Data">Adding Emission Data</a><a id="Adding-Emission-Data-1"></a><a class="docs-heading-anchor-permalink" href="#Adding-Emission-Data" title="Permalink"></a></h2><p>GasChem.jl incorporates an emissions model that utilizes data from the <a href="https://gaftp.epa.gov/Air/emismod/2016/v1/gridded/monthly_netCDF/">US National Emissions Inventory for the year 2016</a>. This model is activated as an extension when the <code>EarthSciData</code> package is used. Here&#39;s a simple example:</p><pre><code class="language-julia hljs">using GasChem, EarthSciData # This will trigger the emission extension
using Dates, ModelingToolkit, OrdinaryDiffEqDefault, OrdinaryDiffEqRosenbrock,
      EarthSciMLBase
using Plots, DynamicQuantities
using ModelingToolkit: t

domain = DomainInfo(
    Dates.DateTime(2016, 5, 1), Dates.DateTime(2016, 5, 4);
    lonrange = deg2rad(-129):deg2rad(1):deg2rad(-61),
    latrange = deg2rad(11):deg2rad(1):deg2rad(59),
    levrange = 1:1:3)

emis = NEI2016MonthlyEmis(&quot;mrggrid_withbeis_withrwc&quot;, domain)

model_noemis = couple(SuperFast(), FastJX(get_tref(domain))) # A model with chemistry and photolysis, but no emissions.
model_withemis = couple(SuperFast(), FastJX(get_tref(domain)), emis) # The same model with emissions.

sys_noemis = convert(System, model_noemis)
sys_withemis = convert(System, model_withemis)

tspan = EarthSciMLBase.get_tspan(domain)
sol_noemis = solve(ODEProblem(sys_noemis, [], tspan; build_initializeprob = false), Rosenbrock23())
sol_withemis = solve(ODEProblem(sys_withemis, [], tspan; build_initializeprob = false), Rosenbrock23())

vars = unknowns(sys_noemis)  # Get the variables in the composed system
var_dict = Dict(string(var) =&gt; var for var in vars)
pols = [&quot;O3&quot;, &quot;OH&quot;, &quot;NO&quot;, &quot;NO2&quot;, &quot;CH3O2&quot;, &quot;CO&quot;, &quot;CH3OOH&quot;, &quot;CH2O&quot;, &quot;ISOP&quot;]
var_names_p = [&quot;SuperFast₊$(v)(t)&quot; for v in pols]

pp = []
for (i, v) in enumerate(var_names_p)
    p = plot(unix2datetime.(sol_noemis[t] .+ get_tref(domain)), sol_noemis[var_dict[v]],
        label = &quot;No Emissions&quot;, title = v,
        size = (1000, 600), xrotation = 45)
    plot!(unix2datetime.(sol_withemis[t] .+ get_tref(domain)),
        sol_withemis[var_dict[v]], label = &quot;With Emissions&quot;)
    push!(pp, p)
end
Plots.plot(pp..., layout = (3, 3))</code></pre><img src="28f69366.svg" alt="Example block output"/></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../climate_forcing/">« Climate Forcing</a><a class="docs-footer-nextpage" href="../api/">API »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.17.0 on <span class="colophon-date" title="Saturday 21 February 2026 21:20">Saturday 21 February 2026</span>. Using Julia version 1.12.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
